rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ðŸ›¡ï¸ Tasks Collection - ×¨×§ ×”×ž×©×ª×ž×© ×™×›×•×œ ×œ×’×©×ª ×œ×ž×©×™×ž×•×ª ×©×œ×•
    match /tasks/{taskId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.userId
        && validateTask(request.resource.data);
    }
    
    // ðŸ›¡ï¸ Chat Messages - ×¨×§ ×”×ž×©×ª×ž×© ×™×›×•×œ ×œ×’×©×ª ×œ×”×•×“×¢×•×ª ×©×œ×•
    match /chat_messages/{messageId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.userId
        && validateChatMessage(request.resource.data);
    }
    
    // ðŸ›¡ï¸ User Profiles - ×¨×§ ×”×ž×©×ª×ž×© ×™×›×•×œ ×œ×’×©×ª ×œ×¤×¨×•×¤×™×œ ×©×œ×•
    match /users/{userId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == userId;
    }
    
    // ðŸš« ×”×›×œ ××—×¨ - ××¡×•×¨
    match /{document=**} {
      allow read, write: if false;
    }
  }
  
  // ðŸ“ ×•×œ×™×“×¦×™×” ×œ×ž×©×™×ž×•×ª
  function validateTask(task) {
    return task.keys().hasAll(['title', 'completed', 'createdAt', 'updatedAt', 'userId'])
      && task.title is string
      && task.title.size() > 0
      && task.title.size() <= 200
      && task.completed is bool
      && task.userId is string
      && task.createdAt is timestamp
      && task.updatedAt is timestamp;
  }
  
  // ðŸ’¬ ×•×œ×™×“×¦×™×” ×œ×”×•×“×¢×•×ª ×¦'××˜
  function validateChatMessage(message) {
    return message.keys().hasAll(['content', 'sender', 'timestamp', 'userId'])
      && message.content is string
      && message.content.size() > 0
      && message.content.size() <= 5000
      && message.sender in ['user', 'ai']
      && message.userId is string
      && message.timestamp is timestamp;
  }
}